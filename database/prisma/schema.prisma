generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgres"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

enum TokenTypes {
  MagicLogin
  Refresh
  ConfirmEmail
  ResetPassword
  InviteUser
}

enum EmailTemplates {
  Welcome
  MagicLink
  ConfirmEmail
  ForgotPassword
  Invite
}

enum AuthProviders {
  MagicLogin
  EmailAndPassword
}

enum CustomDomainStatus {
  Verifying
  Verified
  Failed
}

enum SubscriptionStatus {
  Active
  Cancelled
}

enum MetadataModelType {
  String
  Number
  Boolean
  JSON
  List
}

enum MetadataModelContext {
  Environment
  User
  Organization
}

enum UserDataType {
  Internal
  Metadata
}

model User {
  id             String    @id @default(uuid())
  fullName       String?
  email          String
  profilePicture String?
  password       String?
  lastSignIn     DateTime?
  thonLabsUser   Boolean   @default(false)
  active         Boolean   @default(true)
  emailConfirmed Boolean   @default(false)
  invitedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  environmentId String?
  projects      Project[]

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userData       UserData[]

  @@map("users")
}

model UserData {
  id        Int          @id @default(autoincrement())
  key       String
  value     Json
  userId    String
  type      UserDataType @default(Internal)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("user_data")
}

model Project {
  id           String        @id
  appName      String
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  userOwner    User          @relation(fields: [userOwnerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userOwnerId  String
  main         Boolean       @default(false)
  environments Environment[]

  @@map("projects")
}

model Environment {
  id                            String              @id
  name                          String
  active                        Boolean             @default(true)
  publicKey                     String              @unique
  publicKeyHash                 String              @unique
  secretKey                     String              @unique
  secretKeyHash                 String              @unique
  tokenExpiration               String              @default("1d")
  refreshTokenExpiration        String?             @default("10d")
  appURL                        String?
  authProvider                  AuthProviders       @default(MagicLogin)
  createdAt                     DateTime            @default(now())
  updatedAt                     DateTime            @updatedAt
  customDomain                  String?
  customDomainStartValidationAt DateTime?
  customDomainLastValidationAt  DateTime?
  customDomainStatus            CustomDomainStatus?
  customDomainTXT               String?
  customDomainTXTStatus         CustomDomainStatus?

  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  projectId       String
  users           User[]
  emailsTemplates EmailTemplate[]
  tokens          TokenStorage[]
  environmentData EnvironmentData[]
  organizations   Organization[]
  metadataModels  MetadataModel[]

  @@map("environments")
}

model Organization {
  id            String   @id @default(uuid())
  name          String
  domains       Json     @default("[]")
  logo          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  active        Boolean  @default(true)
  environmentId String

  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  users       User[]

  @@map("organizations")
}

model EnvironmentData {
  id            Int      @id @default(autoincrement())
  key           String
  value         Json
  environmentId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("environment_data")
}

model EmailTemplate {
  id            String         @id @default(uuid())
  type          EmailTemplates
  name          String
  subject       String
  fromName      String
  fromEmail     String
  content       String         @db.Text
  contentJSON   Json?
  bodyStyles    Json?
  preview       String?
  replyTo       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  enabled       Boolean        @default(true)
  environment   Environment    @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  environmentId String

  @@map("emails_templates")
}

model TokenStorage {
  token      String     @id
  expires    DateTime
  createdAt  DateTime   @default(now())
  type       TokenTypes
  // Relation ID can be user ID or any other ID that's related to the token
  // and it's necesasry to complete some action.
  relationId String

  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  environmentId String?

  @@map("tokens_storage")
}

model MetadataModel {
  id            Int                  @id @default(autoincrement())
  name          String
  key           String
  description   String?
  type          MetadataModelType
  options       Json?
  context       MetadataModelContext
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  values        MetadataValue[]
  environmentId String
  environment   Environment          @relation(fields: [environmentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("metadata_models")
}

model MetadataValue {
  metadataModelId Int
  relationId      String
  value           Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  metadataModel MetadataModel @relation(fields: [metadataModelId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([metadataModelId, relationId])
  @@map("metadata_values")
}
